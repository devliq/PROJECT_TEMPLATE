#!/bin/sh

# Load nvm
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

# Load Node.js version from .nvmrc if it exists
if [ -f ".nvmrc" ]; then
  nvm use
fi

echo "ğŸ” Running pre-commit quality checks..."
echo "Current directory: $(pwd)"
echo "Node version: $(node --version)"
echo "NPM version: $(npm --version)"

# Run lint-staged first (handles formatting and basic linting) only if there are staged files
if [ -n "$(git diff --cached --name-only)" ]; then
  echo "ğŸ“ Running lint-staged..."
  if ./node_modules/.bin/lint-staged; then
    echo "âœ… lint-staged passed"
  else
    echo "âŒ lint-staged failed"
    exit 1
  fi
else
  echo "ğŸ“ No staged files, skipping lint-staged"
fi

# Run TypeScript type checking
echo "ğŸ”§ Running TypeScript type checking..."
if npm run typecheck; then
  echo "âœ… TypeScript typecheck passed"
else
  echo "âŒ TypeScript typecheck failed"
  exit 1
fi

# Run security checks
echo "ğŸ”’ Running security checks..."
if npm run security:audit; then
  echo "âœ… Security audit passed"
else
  echo "âŒ Security audit failed"
  exit 1
fi

# Run comprehensive tests
echo "ğŸ§ª Running tests..."
if npm test; then
  echo "âœ… Tests passed"
else
  echo "âŒ Tests failed"
  exit 1
fi

echo "âœ… All pre-commit checks passed!"
