#!/bin/sh

# Load nvm
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

# Load Node.js version from .nvmrc if it exists
if [ -f ".nvmrc" ]; then
  nvm use
fi

echo "🔍 Running pre-commit quality checks..."
echo "Current directory: $(pwd)"
echo "Node version: $(node --version)"
echo "NPM version: $(npm --version)"

# Run lint-staged first (handles formatting and basic linting) only if there are staged files
if [ -n "$(git diff --cached --name-only)" ]; then
  echo "📝 Running lint-staged..."
  if ./node_modules/.bin/lint-staged; then
    echo "✅ lint-staged passed"
  else
    echo "❌ lint-staged failed"
    exit 1
  fi
else
  echo "📝 No staged files, skipping lint-staged"
fi

# Run TypeScript type checking
echo "🔧 Running TypeScript type checking..."
if npm run typecheck; then
  echo "✅ TypeScript typecheck passed"
else
  echo "❌ TypeScript typecheck failed"
  exit 1
fi

# Run security checks
echo "🔒 Running security checks..."
if npm run security:audit; then
  echo "✅ Security audit passed"
else
  echo "❌ Security audit failed"
  exit 1
fi

# Run comprehensive tests
echo "🧪 Running tests..."
if npm test; then
  echo "✅ Tests passed"
else
  echo "❌ Tests failed"
  exit 1
fi

echo "✅ All pre-commit checks passed!"
